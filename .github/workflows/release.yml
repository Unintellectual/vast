name: Release

on:
  push:
    tags:
      - 'v*'

env:
  PROJECT_NAME: Vast
  BUILD_TYPE: Release

jobs:
  build:
    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}

    strategy:
      fail-fast: false
      matrix:
        config:
          - name: Windows Latest MSVC
            os: windows-latest
            platform: Windows

          - name: Ubuntu Latest GCC
            os: ubuntu-latest
            platform: Linux

          - name: macOS Latest Clang
            os: macos-latest
            platform: macOS

    steps:
      - name: Set version name (Windows)
        if: runner.os == 'Windows'
        id: version_win
        shell: pwsh
        run: |
          $tag = "${env:GITHUB_REF}" -replace 'refs/tags/', ''
          "name=$tag" >> $env:GITHUB_OUTPUT

      - name: Set version name
        if: runner.os != 'Windows'
        id: version
        shell: bash
        run: |
          echo "name=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            ~/.local
            C:\Users\runneradmin\.local
          key: ${{ runner.os }}-dependencies-${{ hashFiles('CMakeLists.txt') }}

      - name: Install GoogleTest
        if: steps.cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          cd ..
          git clone https://github.com/google/googletest.git --branch v1.17.0
          cd googletest
          cmake -B build -DCMAKE_INSTALL_PREFIX="$HOME/.local" -Dgtest_force_shared_crt=1
          cmake --build build --config Release
          cmake --build build --target install --config Release
          cd ../Vast

      - name: Configure
        shell: bash
        run: |
          cmake -B build -DCMAKE_INSTALL_PREFIX="$HOME/.local"

      - name: Build
        shell: bash
        run: |
          cmake --build build --config "${{ env.BUILD_TYPE }}" -j4

      - name: Run tests
        shell: bash
        run: |
          cd build
          ctest -C "${{ env.BUILD_TYPE }}" -VV

      - name: Generate archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force build
          7z a "$HOME/artifact.zip" *

      - name: Generate archive (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          rm -rf build
          tar -czf "$HOME/artifact.tar.gz" .

      - name: Upload artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.config.platform }}-${{ steps.version_win.outputs.name }}
          path: ~/artifact.zip

      - name: Upload artifact (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.config.platform }}-${{ steps.version.outputs.name }}
          path: ~/artifact.tar.gz

  release:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Set version name
        id: version
        shell: bash
        run: |
          echo "name=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.version.outputs.name }}
          draft: false
          prerelease: false

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: Linux-${{ steps.version.outputs.name }}

      - name: Upload Linux release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifact.tar.gz
          asset_name: ${{ env.PROJECT_NAME }}-Linux-${{ steps.version.outputs.name }}.tar.gz
          asset_content_type: application/x-tar

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: Windows-${{ steps.version.outputs.name }}

      - name: Upload Windows release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifact.zip
          asset_name: ${{ env.PROJECT_NAME }}-Windows-${{ steps.version.outputs.name }}.zip
          asset_content_type: application/zip

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: macOS-${{ steps.version.outputs.name }}

      - name: Upload macOS release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifact.tar.gz
          asset_name: ${{ env.PROJECT_NAME }}-macOS-${{ steps.version.outputs.name }}.tar.gz
          asset_content_type: application/x-tar
